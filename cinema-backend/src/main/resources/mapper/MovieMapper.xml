<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tt.cm.mapper.MovieMapper">

    <resultMap id="MovieResult" type="Movie">
        <id property="movieId" column="movie_id"></id>
        <collection property="movieCategoryList" column="movie_id" select="com.tt.cm.mapper.MovieCategoryMapper.findOneMovieCategorys"></collection>
    </resultMap>

    <select id="findAllMovies" resultMap="MovieResult" parameterType="SysMovieVo">
        select sm.* from movie sm
        <if test="movieCategoryId != null and movieCategoryId > 0">
            join movie_to_category smtc on sm.movie_id = smtc.movie_id
            join movie_category smc on smtc.movie_category_id = smc.movie_category_id
        </if>
        <where>
            del_state = 0
            <if test="movieName != null and movieName != ''">
                and sm.movie_name like concat('%', #{movieName}, '%')
            </if>
            <if test="movieArea != null and movieArea !=''">
                and sm.movie_area = #{movieArea}
            </if>
            <if test="startDate != null">
                and sm.release_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                and sm.release_date &lt;= #{endDate}</if>
            <if test="movieCategoryId != null and movieCategoryId > 0">
                and smc.movie_category_id = #{movieCategoryId}
            </if>
        </where>
    </select>

    <select id="findMovieById" resultMap="MovieResult" parameterType="long">
        select * from movie where movie_id = #{id}
    </select>

    <!--根据id查询单个电影信息，不需要相关的额外信息-->
    <select id="findOneMovie" resultType="Movie" parameterType="long">
        select * from movie where movie_id = #{id}
    </select>

    <update id="addMovie" parameterType="Movie">
        insert into movie(
            <if test=" movieName != null and movieName != ''">movie_name,</if>
            <if test=" movieLength != null and movieLength != 0">movie_length,</if>
            <if test=" moviePoster != null and moviePoster != ''">movie_poster,</if>
            <if test=" movieArea != null and movieArea != ''">movie_area,</if>
            <if test=" movieIntroduction != null and movieIntroduction != ''">movie_introduction,</if>
            <if test=" releaseDate != null">release_date,</if>
            <if test=" moviePictures != null and moviePictures != ''">movie_pictures</if>
        ) values(
            <if test=" movieName != null and movieName != ''">#{movieName},</if>
            <if test=" movieLength != null and movieLength != 0">#{movieLength},</if>
            <if test=" moviePoster != null and moviePoster != ''">#{moviePoster},</if>
            <if test=" movieArea != null and movieArea != ''">#{movieArea},</if>
            <if test=" movieIntroduction != null and movieIntroduction != ''">#{movieIntroduction},</if>
            <if test=" releaseDate != null">#{releaseDate},</if>
            <if test=" moviePictures != null and moviePictures != ''">#{moviePictures}</if>
        )
    </update>

    <update id="updateMovie" parameterType="Movie">
        update movie
        set
        <if test=" movieName != null and movieName != ''">movie_name = #{movieName},</if>
        <if test=" movieLength != null and movieLength != 0">movie_length = #{movieLength},</if>
        <if test=" moviePoster != null and moviePoster != ''">movie_poster = #{moviePoster},</if>
        <if test=" movieIntroduction != null and movieIntroduction != ''">movie_introduction = #{movieIntroduction},</if>
        <if test=" releaseDate != null">release_date = #{releaseDate},</if>
        <if test=" movieBoxOffice != null">movie_box_office = #{movieBoxOffice},</if>
        <if test=" moviePictures != null and moviePictures != ''">movie_pictures = #{moviePictures},</if>
        <if test=" movieArea != null and movieArea != ''">movie_area = #{movieArea}</if>
        where movie_id = #{movieId}
    </update>

    <update id="deleteMovie" parameterType="Long">
        update movie set del_state = 1 where movie_id = #{movieId}
    </update>

    <!--查询指定影院的所有上映电影，包含主演名字、影片类别-->
    <select id="findMovieByCinemaId" parameterType="Long" resultMap="MovieResult">
        select distinct sm.* from movie sm
        join session ss on sm.movie_id = ss.movie_id
        where ss.session_date &gt;= CURDATE()
    </select>

    <!-- 查询各种榜单信息 -->
    <!-- 总票房榜 -->
    <select id="totalBoxOfficeList" resultMap="MovieResult">
        select sm.* from movie sm
        where del_state = 0 and sm.release_date &lt;= curdate()
        order by sm.movie_box_office desc
    </select>

    <!-- 国内票房榜：已上映的国内电影中，按票房取前10 -->
    <select id="domesticBoxOfficeList" resultMap="MovieResult">
        select sm.* from movie sm
        where del_state = 0 and sm.movie_area in ("中国大陆", "中国香港", "中国台湾") and sm.release_date &lt;= curdate()
        order by sm.movie_box_office desc
    </select>
    
    <!-- 国外票房榜：已上映的国外电影中，按票房取前10 -->
    <select id="foreignBoxOfficeList" resultMap="MovieResult">
        select sm.* from movie sm
        where del_state = 0 and sm.movie_area not in ("中国大陆", "中国香港", "中国台湾") and sm.release_date &lt;= curdate()
        order by sm.movie_box_office desc
    </select>
</mapper>